# Embedded system TermProject
## 센서를 활용한 알람 시계 제작

금오공과대학교 컴퓨터공학과<br>
임베디드시스템 1분반 - 5팀<br>
신상호 20180630<br>
이인재 20180894<br>
이재형 20180904<br>
이정우 20190893<br>

## 목차
1. 프로젝트 개요
2. 초안
3. 1차 구현
4. 최종 구현

### 1. 프로젝트 개요
**센서 및 액추에이터를 활용한 알람 시계 제작**<br>
기본적인 알람 기능 외에 부가적인 기능도 추가한 다기능 알람시계를 목표로 제작하였습니다.<br>
모터를 이용하여 전등을 키고, 알람 종료 조건을 귀찮게 만듬으로써 사용자가 잠에서 깨지 않고는 못배기게 만든 알람시계입니다.<br>

기능 목록
- 알람 기능
- 특정 조건을 만족해야만 알람이 꺼지는 기능
- 자동으로 전등의 on/off 조절

### 2. 초안
기능 목록
- 조도 센서와 RTC 모듈을 사용하여 알람 타이밍 결정
- 패시브 스피커를 통해 알람 출력
- FND 상의 숫자를 넘버 패드로 입력하면 알람 종료
- 서보 모터를 사용하여 전등 스위치를 물리적으로 제어
- DC 모터를 이용하여 커튼 걷기

사용 센서 or 액추에이터 목록
- PWM : 패시브 스피커, DC 모터, 서보 모터
- I2C : RTC, 조도 센서, 숫자 키 패드
- GPIO : FND

프로그램 흐름
main 함수 실행 후, 조도 센서와 RTC 모듈의 동작을 백그라운드 프로세스로 실행시킨다.<br>
이후, 이 백그라운드 프로세스들은 메인 프로세스와 IPC로 데이터를 주고받으며 알람 시간 설정 및 알람 시작을 결정한다.<br>
알람이 울리기 시작하면, 각 모듈의 동작들을 쓰레드를 통해 동시다발적으로 실행한다.<br>
![Alt text](<image/Screenshot 2023-12-21 at 2.42.48 PM.png>)

### 3. 1차 구현
설계 변경 사항
- 숫자 키 패드 및 스피커의 구동 방식 변경 - GPIO를 통한 구동
- PWM모듈 간 충돌 발생. 우선순위에서 밀리는 모듈 제거 - DC 모터
- 사용 목적이 불분명한 센서 제거 - 조도 센서
- 교수님의 피드백을 받아 통신 모듈 추가 - 블루투스 모듈

1차 구현 시 사용한 모듈
- PWM : 서보 모터
- I2C : RTC
- GPIO : FND, 패시브 스피커, 숫자 키 패드(기능 구현 X)
- UART : 블루투스

프로그램 흐름 변경<br>
백그라운드 프로세스 -> 전부 쓰레드로 대체<br>
블루투스 쓰레드에서 알람 시간 설정<br>
mutex의 lock을 이용하여 알람 시간 설정 시 임계구역 문제 방지<br>
메인 쓰레드에서 설정한 시간이 되면 알람 구동<br>
![Alt text](image/image.png)

데모 영상<br>


### 3. 최종 구현
설계 변경 사항
- FND 제외(독립적인 동작은 되나 병합 시 I2C버스 오류 발생)
- 숫자 키 패드 기능 구현

사용 모듈
1. 서보 모터 (PWM) : 전등 스위치의 물리적 on/off
2. RTC (I2C) : 시간 측정 모듈
3. 패시브 스피커 : 알람 시각에 알람음 출력
4. 숫자 키 패드 : 알람 종료를 위해 4자리 숫자를 받는 입력장치
5. 블루투스 (UART) : 스마트폰과 블루투스를 통해 알람 시각 입력

회로도<br>
![Alt text](image/image_4.png)
GPIO 핀 상세<br>
스피커 - GPIO 16<br>
서보 모터 - GPIO 13 (PWM 1)<br>
숫자 키 패드 - SCL = GPIO 21, SDA = GPIO 20<br>
bluetooth - TXD = GPIO 1, RXD = GPIO 0 (UART)<br>
RTC - SDA = GPIO 2, SDL = GPIO 3 (I2C)<br>

프로그램 흐름도<br>
각 모듈마다 하나의 쓰레드 할당. <br>
메인 쓰레드는 쓰레드 컨트롤만 담당.<br>
![Alt text](image/image_2.png)

각 모듈 별 임계구역 접근도<br>
교착상태를 일으키는 변수가 총 2개 존재한다.<br>
이에 접근하는 모듈들을 도식화하여 나타내었다.<br>
![Alt text](image/image_3.png)

